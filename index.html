<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mr. Duryea | Class Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="img/favicon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="img/favicon-512.png">
  </head>
  <body>
    <div class="hallpass-menu">
      <button class="hallpass-trigger" type="button">Hall Pass</button>
    </div>
    <div class="hallpass-modal" id="hallpassModal" aria-hidden="true">
      <div class="hallpass-dialog" role="dialog" aria-modal="true" aria-labelledby="hallpassTitle" aria-describedby="hallpassDesc">
        <h2 id="hallpassTitle">Use the Hall Pass?</h2>
        <p id="hallpassDesc">Press continue, then take the hall pass. Be as fast as you can.</p>
        <p class="hallpass-reminder">Leave this tab open while you are out. When you return, click I'm Back.</p>
        <p class="hallpass-status" id="hallpassStatus" aria-live="polite"></p>
        <div class="hallpass-actions">
          <button class="hallpass-action primary" type="button" id="hallpassContinue">Continue</button>
          <button class="hallpass-action ghost" type="button" id="hallpassCancel">Cancel</button>
        </div>
      </div>
    </div>
    <div class="hallpass-active" id="hallpassActive" aria-hidden="true">
      <div class="hallpass-active-card">
        <span class="hallpass-pill">Hall Pass In Use</span>
        <div class="hallpass-timer" id="hallpassTimer">0:00</div>
        <p class="hallpass-active-note">Leave this tab open while you are out. When you return, click I'm Back.</p>
        <p class="hallpass-active-status" id="hallpassActiveStatus" aria-live="polite"></p>
        <button class="hallpass-action primary" type="button" id="hallpassBack">I'm Back</button>
      </div>
    </div>
    <main class="gateway" aria-label="Class selection">
      <h1 class="gateway-title">Click Your Class</h1>
      <div class="class-grid">
        <a class="class-button accent-ecs" href="expl-comp-sci/index.html">Exploring Computer Science</a>
        <a class="class-button accent-web" href="web-dev/index.html">Web Development</a>
        <a class="class-button accent-lit" href="dig-lit/index.html">Digital Literacy</a>
        <a class="class-button accent-python" href="intro-to-python/index.html">Intro to Python</a>
      </div>
      <section class="year-progress" aria-label="School year progress">
        <div class="year-progress-strip">
          <div class="year-progress-track" id="yearProgressTrack" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="year-progress-fill" id="yearProgressFill"></div>
            <button class="progress-dot" type="button" data-marker="start" aria-label="Q1 begins"></button>
            <button class="progress-dot" type="button" data-marker="q2" aria-label="Q2 begins"></button>
            <button class="progress-dot" type="button" data-marker="q3" aria-label="Q3 begins"></button>
            <button class="progress-dot" type="button" data-marker="q4" aria-label="Q4 begins"></button>
            <button class="progress-dot" type="button" data-marker="end" aria-label="Last day"></button>
            <button class="progress-dot today" type="button" id="todayMarker" aria-label="Today"></button>
          </div>
        </div>
      </section>
      <div class="profile" aria-label="Teacher information">
        <div class="signature-wrap">
          <img class="signature" src="img/brian-duryea-signature.png" alt="Brian Duryea signature">
        </div>
      </div>
    </main>
    <footer class="site-footer">
      <span class="footer-mark">Mr. Duryea</span>
      <nav class="footer-links" aria-label="Footer">
        <a href="index.html">Home</a>
        <a href="about/index.html">About</a>
        <a href="privacy/index.html">Privacy</a>
      </nav>
    </footer>
    <script>
      (function () {
        var trigger = document.querySelector(".hallpass-trigger");
        if (!trigger) {
          return;
        }

        var modal = document.getElementById("hallpassModal");
        var statusEl = document.getElementById("hallpassStatus");
        var continueBtn = document.getElementById("hallpassContinue");
        var cancelBtn = document.getElementById("hallpassCancel");
        var activeScreen = document.getElementById("hallpassActive");
        var timerEl = document.getElementById("hallpassTimer");
        var activeStatusEl = document.getElementById("hallpassActiveStatus");
        var backBtn = document.getElementById("hallpassBack");

        var tokenKey = "hallpass_token";
        var startedKey = "hallpass_started_at";
        var timerId = null;
        var activeStart = null;

        function setStatus(message, tone) {
          statusEl.textContent = message;
          if (tone) {
            statusEl.setAttribute("data-tone", tone);
          } else {
            statusEl.removeAttribute("data-tone");
          }
        }

        function setActiveStatus(message) {
          activeStatusEl.textContent = message || "";
        }

        function openModal() {
          setStatus("");
          modal.classList.add("is-visible");
          modal.setAttribute("aria-hidden", "false");
          continueBtn.focus();
        }

        function closeModal() {
          modal.classList.remove("is-visible");
          modal.setAttribute("aria-hidden", "true");
        }

        function lockBody(locked) {
          if (locked) {
            document.body.classList.add("hallpass-locked");
          } else {
            document.body.classList.remove("hallpass-locked");
          }
        }

        function formatDuration(ms) {
          var totalSeconds = Math.max(0, Math.floor(ms / 1000));
          var minutes = Math.floor(totalSeconds / 60);
          var seconds = totalSeconds % 60;
          return minutes + ":" + String(seconds).padStart(2, "0");
        }

        function renderTimer() {
          if (!activeStart) {
            return;
          }
          timerEl.textContent = formatDuration(Date.now() - activeStart);
        }

        function startTimer() {
          stopTimer();
          renderTimer();
          timerId = window.setInterval(renderTimer, 1000);
        }

        function stopTimer() {
          if (timerId) {
            window.clearInterval(timerId);
            timerId = null;
          }
        }

        function handleBeforeUnload(event) {
          event.preventDefault();
          event.returnValue = "Hall pass is active. Keep this screen open until you return.";
          return event.returnValue;
        }

        function showActive(startedAt) {
          activeStart = startedAt;
          activeScreen.classList.add("is-visible");
          activeScreen.setAttribute("aria-hidden", "false");
          lockBody(true);
          setActiveStatus("");
          startTimer();
          window.addEventListener("beforeunload", handleBeforeUnload);
        }

        function hideActive() {
          activeStart = null;
          activeScreen.classList.remove("is-visible");
          activeScreen.setAttribute("aria-hidden", "true");
          lockBody(false);
          stopTimer();
          setActiveStatus("");
          window.removeEventListener("beforeunload", handleBeforeUnload);
        }

        function saveSession(token, startedAt) {
          localStorage.setItem(tokenKey, token);
          localStorage.setItem(startedKey, String(startedAt));
        }

        function clearSession() {
          localStorage.removeItem(tokenKey);
          localStorage.removeItem(startedKey);
        }

        function getToken() {
          return localStorage.getItem(tokenKey);
        }

        function getStartedAt() {
          var stored = parseInt(localStorage.getItem(startedKey), 10);
          return Number.isFinite(stored) ? stored : null;
        }

        function isLocalHost() {
          return (
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1" ||
            window.location.hostname === "::1"
          );
        }

        async function postAction(action, token, extra) {
          var payload = { action: action };
          if (token) {
            payload.token = token;
          }
          if (extra) {
            Object.keys(extra).forEach(function (key) {
              payload[key] = extra[key];
            });
          }
          var response = null;
          try {
            response = await fetch("/api/hallpass", {
              method: "POST",
              headers: {
                "content-type": "application/json"
              },
              body: JSON.stringify(payload)
            });
          } catch (error) {
            var networkError = new Error("Network request failed");
            networkError.code = "network";
            throw networkError;
          }

          var data = null;
          try {
            data = await response.json();
          } catch (error) {
            data = null;
          }

          if (!response.ok) {
            var message = data && data.message ? String(data.message) : "";
            var requestError = new Error(message || "Request failed");
            requestError.status = response.status;
            requestError.payload = data;
            throw requestError;
          }

          return data;
        }

        async function claimPass() {
          setStatus("Checking availability...", "info");
          try {
            var data = await postAction("claim");
            if (data.status === "claimed") {
              saveSession(data.token, data.startedAt);
              closeModal();
              showActive(data.startedAt);
              return;
            }
            if (data.status === "blocked") {
              setStatus("Hall pass is blocked. Ask Mr. Duryea.", "error");
              return;
            }
            if (data.status === "in_use") {
              setStatus("Sorry, it is in use.", "error");
              return;
            }
            setStatus("Unable to start the hall pass. Try again.", "error");
          } catch (error) {
            if (error && error.status === 404) {
              setStatus(
                isLocalHost()
                  ? "Hall pass system is not running on this local server. Use the live site or run Cloudflare Pages dev."
                  : "Hall pass system is unavailable right now. Ask Mr. Duryea.",
                "error"
              );
              return;
            }

            if (error && error.status >= 500) {
              setStatus(
                isLocalHost() && error.message ? error.message : "Hall pass system is unavailable right now. Ask Mr. Duryea.",
                "error"
              );
              return;
            }

            setStatus("Unable to check the hall pass. Try again.", "error");
          }
        }

        async function releasePass() {
          var token = getToken();
          if (!token) {
            setActiveStatus("This pass is not assigned to this device.");
            return;
          }
          setActiveStatus("Releasing...");
          try {
            var data = await postAction("release", token);
            if (data.status === "released" || data.status === "available") {
              clearSession();
              hideActive();
              return;
            }
            setActiveStatus("Unable to release. Ask Mr. Duryea.");
          } catch (error) {
            if (error && error.status === 404) {
              setActiveStatus(isLocalHost() ? "Hall pass system is not running on this local server." : "Hall pass system is unavailable.");
              return;
            }
            setActiveStatus("Network error. Try again.");
          }
        }

        async function restoreSession() {
          var token = getToken();
          if (!token) {
            return;
          }
          try {
            var data = await postAction("status", token);
            if (data.status === "in_use" && data.isHolder) {
              var start = data.startedAt || getStartedAt() || Date.now();
              showActive(start);
            } else {
              clearSession();
            }
          } catch (error) {
            clearSession();
          }
        }

        trigger.addEventListener("click", openModal);
        cancelBtn.addEventListener("click", closeModal);
        modal.addEventListener("click", function (event) {
          if (event.target === modal) {
            closeModal();
          }
        });
        continueBtn.addEventListener("click", claimPass);
        backBtn.addEventListener("click", releasePass);

        restoreSession();
      })();
    </script>
    <script>
      (function () {
        var track = document.getElementById("yearProgressTrack");
        if (!track) {
          return;
        }

        var timeZone = "America/Denver";
        var msDay = 24 * 60 * 60 * 1000;

        function parseDate(value) {
          var parts = value.split("-").map(Number);
          return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
        }

        function getTodayUtc() {
          var now = new Date();
          var parts = new Intl.DateTimeFormat("en-US", {
            timeZone: timeZone,
            year: "numeric",
            month: "2-digit",
            day: "2-digit"
          }).formatToParts(now);
          var map = {};
          for (var i = 0; i < parts.length; i += 1) {
            if (parts[i].type !== "literal") {
              map[parts[i].type] = parts[i].value;
            }
          }
          return new Date(Date.UTC(Number(map.year), Number(map.month) - 1, Number(map.day)));
        }

        function daysBetween(start, end) {
          return Math.round((end - start) / msDay);
        }

        function clamp(value, min, max) {
          return Math.min(Math.max(value, min), max);
        }

        function percentBetween(start, end, current) {
          var total = Math.max(1, daysBetween(start, end));
          var elapsed = clamp(daysBetween(start, current), 0, total);
          return Math.round((elapsed / total) * 100);
        }

        function findPeriod(periods, today) {
          var current = null;
          var next = null;
          var previous = null;
          for (var i = 0; i < periods.length; i += 1) {
            var period = periods[i];
            if (today >= period.start && today <= period.end) {
              current = period;
              break;
            }
            if (!next && today < period.start) {
              next = period;
            }
            if (today > period.end) {
              previous = period;
            }
          }
          return { current: current, next: next, previous: previous };
        }

        var schedule = {
          label: "2025-2026",
          start: "2025-08-18",
          end: "2026-05-22",
          terms: [
            { id: "Q1", label: "Q1", start: "2025-08-18", end: "2025-10-15" },
            { id: "Q2", label: "Q2", start: "2025-10-20", end: "2025-12-19" },
            { id: "Q3", label: "Q3", start: "2026-01-06", end: "2026-03-09" },
            { id: "Q4", label: "Q4", start: "2026-03-10", end: "2026-05-22" }
          ],
          breaks: [
            { id: "labor", label: "Labor Day", start: "2025-09-01", end: "2025-09-01" },
            { id: "fall", label: "Fall Break", start: "2025-10-16", end: "2025-10-17" },
            { id: "comp-1", label: "Compensation Day", start: "2025-11-26", end: "2025-11-26" },
            { id: "thanksgiving", label: "Thanksgiving Break", start: "2025-11-27", end: "2025-11-28" },
            { id: "winter", label: "Winter Break", start: "2025-12-22", end: "2026-01-02" },
            { id: "pro-jan", label: "Professional Day", start: "2026-01-05", end: "2026-01-05" },
            { id: "mlk", label: "MLK Day", start: "2026-01-19", end: "2026-01-19" },
            { id: "pres", label: "President's Day", start: "2026-02-16", end: "2026-02-16" },
            { id: "pro-mar", label: "Professional Day", start: "2026-03-09", end: "2026-03-09" },
            { id: "spring", label: "Spring Break", start: "2026-03-30", end: "2026-04-03" },
            { id: "comp-2", label: "Compensation Day", start: "2026-04-24", end: "2026-04-24" },
            { id: "memorial", label: "Memorial Day", start: "2026-05-25", end: "2026-05-25" }
          ]
        };

        var terms = schedule.terms.map(function (term) {
          return {
            id: term.id,
            label: term.label,
            start: parseDate(term.start),
            end: parseDate(term.end)
          };
        });

        var yearStart = parseDate(schedule.start);
        var yearEnd = parseDate(schedule.end);
        var today = getTodayUtc();
        var totalDays = Math.max(1, daysBetween(yearStart, yearEnd));
        var elapsedDays = clamp(daysBetween(yearStart, today), 0, totalDays);
        var yearPercent = Math.round((elapsedDays / totalDays) * 100);

        var yearFill = document.getElementById("yearProgressFill");
        if (yearFill) {
          yearFill.style.width = yearPercent + "%";
        }

        track.setAttribute("aria-valuenow", String(yearPercent));
        track.setAttribute("aria-valuetext", "Year " + yearPercent + "% complete");

        var dateFormatter = new Intl.DateTimeFormat("en-US", {
          timeZone: timeZone,
          month: "short",
          day: "numeric",
          year: "numeric"
        });
        var shortFormatter = new Intl.DateTimeFormat("en-US", {
          timeZone: timeZone,
          month: "short",
          day: "numeric"
        });

        function formatDate(date) {
          return dateFormatter.format(date);
        }

        function formatRange(start, end) {
          var sameYear = start.getUTCFullYear() === end.getUTCFullYear();
          var startText = sameYear ? shortFormatter.format(start) : formatDate(start);
          var endText = formatDate(end);
          return startText + " - " + endText;
        }

        var markerDates = {
          start: yearStart,
          q2: terms[1].start,
          q3: terms[2].start,
          q4: terms[3].start,
          end: yearEnd
        };

        var markerTooltips = {
          start: "Q1 begins " + formatDate(yearStart),
          q2: "Q2 begins " + formatDate(terms[1].start),
          q3: "Q3 begins " + formatDate(terms[2].start),
          q4: "Q4 begins " + formatDate(terms[3].start),
          end: "Last day " + formatDate(yearEnd)
        };

        var markerEls = track.querySelectorAll("[data-marker]");
        for (var i = 0; i < markerEls.length; i += 1) {
          var markerEl = markerEls[i];
          var key = markerEl.getAttribute("data-marker");
          var markerDate = markerDates[key];
          if (!markerDate) {
            continue;
          }
          var markerPos = (daysBetween(yearStart, markerDate) / totalDays) * 100;
          markerEl.style.setProperty("--marker-pos", markerPos.toFixed(3) + "%");
          if (markerTooltips[key]) {
            markerEl.setAttribute("data-tooltip", markerTooltips[key]);
            markerEl.setAttribute("aria-label", markerTooltips[key]);
          }
        }

        var breaks = schedule.breaks.map(function (breakItem) {
          return {
            id: breakItem.id,
            label: breakItem.label,
            start: parseDate(breakItem.start),
            end: parseDate(breakItem.end)
          };
        });

        var breakFragment = document.createDocumentFragment();
        for (var b = 0; b < breaks.length; b += 1) {
          var breakItem = breaks[b];
          if (breakItem.end < yearStart || breakItem.start > yearEnd) {
            continue;
          }
          var breakStart = breakItem.start < yearStart ? yearStart : breakItem.start;
          var breakEnd = breakItem.end > yearEnd ? yearEnd : breakItem.end;
          var breakStartPos = (daysBetween(yearStart, breakStart) / totalDays) * 100;
          var breakDays = Math.max(1, daysBetween(breakStart, breakEnd) + 1);
          var breakWidth = Math.max(0.6, (breakDays / totalDays) * 100);
          var breakEl = document.createElement("button");
          breakEl.type = "button";
          breakEl.className = "progress-break";
          breakEl.style.left = breakStartPos.toFixed(3) + "%";
          breakEl.style.width = breakWidth.toFixed(3) + "%";
          var breakTooltip = breakItem.label + " " + formatRange(breakItem.start, breakItem.end);
          breakEl.setAttribute("data-tooltip", breakTooltip);
          breakEl.setAttribute("aria-label", breakTooltip);
          breakFragment.appendChild(breakEl);
        }
        track.appendChild(breakFragment);

        var midtermFragment = document.createDocumentFragment();
        for (var t = 0; t < terms.length; t += 1) {
          var term = terms[t];
          var midpoint = new Date(term.start.getTime() + (term.end.getTime() - term.start.getTime()) / 2);
          var midPos = (daysBetween(yearStart, midpoint) / totalDays) * 100;
          var tick = document.createElement("button");
          tick.type = "button";
          tick.className = "progress-tick";
          tick.setAttribute("data-direction", t % 2 === 0 ? "up" : "down");
          tick.style.setProperty("--marker-pos", midPos.toFixed(3) + "%");
          var tickTooltip = term.label + " midpoint " + formatDate(midpoint);
          tick.setAttribute("data-tooltip", tickTooltip);
          tick.setAttribute("aria-label", tickTooltip);
          midtermFragment.appendChild(tick);
        }
        track.appendChild(midtermFragment);

        var todayMarker = document.getElementById("todayMarker");
        if (todayMarker) {
          var todayPos = (elapsedDays / totalDays) * 100;
          todayMarker.style.setProperty("--marker-pos", todayPos.toFixed(3) + "%");
        }

        var totalWeeks = Math.floor(totalDays / 7) + 1;
        var weekNumber = 0;
        if (today >= yearStart && today <= yearEnd) {
          weekNumber = Math.floor(elapsedDays / 7) + 1;
        } else if (today > yearEnd) {
          weekNumber = totalWeeks;
        }

        var termStatus = findPeriod(terms, today);
        var termTooltip = "";
        if (termStatus.current) {
          var termPercent = percentBetween(termStatus.current.start, termStatus.current.end, today);
          termTooltip = termStatus.current.label + " " + termPercent + "%";
        } else if (termStatus.next) {
          termTooltip = "Break before " + termStatus.next.label;
        } else if (termStatus.previous) {
          termTooltip = termStatus.previous.label + " complete";
        }

        var todayTooltip = "";
        if (today < yearStart) {
          todayTooltip = "School year starts " + formatDate(yearStart);
        } else if (today > yearEnd) {
          todayTooltip = "School year ended " + formatDate(yearEnd);
        } else {
          todayTooltip = "Week " + weekNumber + " of " + totalWeeks;
          if (termTooltip) {
            todayTooltip += " | " + termTooltip;
          }
          todayTooltip += " | " + formatDate(today);
        }
        if (todayMarker) {
          todayMarker.setAttribute("data-tooltip", todayTooltip);
          todayMarker.setAttribute("aria-label", todayTooltip);
        }
      })();
    </script>
  </body>
</html>
